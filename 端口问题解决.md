# 端口问题解决方案

## 问题描述

遇到以下错误：
```
Error: listen EACCES: permission denied ::1:1420
Error: listen EACCES: permission denied ::1:5173
```

## 根本原因

**不是端口被占用，而是 Windows IPv6 权限问题！**

- `::1` 是 IPv6 的 localhost
- Windows 某些配置下，Node.js 无法绑定 IPv6 地址
- 需要强制使用 IPv4 (`127.0.0.1`)

## ✅ 已修复

**配置已更新**: Vite 现在强制使用 IPv4 地址 (`127.0.0.1`)，避免 Windows IPv6 权限问题。

### 修改内容

在 `vite.config.ts` 中：
```typescript
server: {
  host: host || "127.0.0.1",  // 强制使用 IPv4
}
```

## 如何使用

### 1. 启动开发服务器

```powershell
pnpm run dev
```

### 2. 查看控制台输出

```
  VITE v7.1.9  ready in 164 ms

  ➜  Local:   http://127.0.0.1:5173/    ← 使用这个地址（IPv4）
  ➜  Network: use --host to expose
```

### 3. 在浏览器打开 http://127.0.0.1:5173/

**注意**: 使用 `127.0.0.1`（IPv4）而不是 `localhost`（可能解析为 IPv6）

## 运行完整应用（需要 Rust）

如果要运行完整的 Tauri 应用：

```powershell
pnpm tauri dev
```

这会使用固定端口 1420。如果遇到端口冲突：

### 解决方法 1: 关闭占用端口的程序

查找占用 1420 端口的程序：
```powershell
netstat -ano | findstr :1420
```

根据 PID 结束进程：
```powershell
taskkill /PID <进程ID> /F
```

### 解决方法 2: 修改 Tauri 配置

编辑 `src-tauri/tauri.conf.json`，修改 `devUrl` 使用不同端口。

## 技术细节

### Vite 配置说明

```typescript
server: {
  // 运行 tauri dev 时使用 1420，否则自动选择
  port: host ? 1420 : undefined,
  strictPort: !!host, // 仅 Tauri 模式强制端口
  host: host || "localhost",
}
```

### 端口选择逻辑

1. **开发模式** (`pnpm run dev`):
   - 尝试 5173（Vite 默认）
   - 如果占用，尝试 5174、5175...
   - 自动选择第一个可用端口

2. **Tauri 模式** (`pnpm tauri dev`):
   - 必须使用 1420（Tauri 要求）
   - 如果端口被占用，报错并退出

## 其他可能的解决方案

### 临时禁用 IPv6（如果问题持续）

```powershell
# 以管理员身份运行 PowerShell
netsh interface ipv6 set global randomizeidentifiers=disabled
```

### 检查防火墙设置

1. 打开 Windows Defender 防火墙
2. 允许应用通过防火墙
3. 添加 Node.js 和 pnpm

### 使用不同的 host

在 `vite.config.ts` 中修改：
```typescript
host: "127.0.0.1", // 使用 IPv4 而不是 localhost
```

## 总结

✅ **推荐做法**: 使用 `pnpm run dev` 进行前端开发，让 Vite 自动选择端口

✅ **完整应用**: 需要运行 `pnpm tauri dev` 时，确保 1420 端口可用

✅ **快速开始**: 双击 `start-dev.bat`，查看控制台输出的地址

---

**问题已解决**: 现在可以正常运行开发服务器了！
